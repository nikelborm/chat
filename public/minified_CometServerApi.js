if(!window._tabSignal){var _tabSignal=function(opt){this.slotArray=new Array;this.debug=false;this.sigId=0;this.tabUUID=undefined;this.getTabUUID=function(){if(!this.tabUUID){this.tabUUID="";for(var i=0;i<16;i++){this.tabUUID+="qwertyuiopasdfghjklzxcvbnm1234567890QWERTYUIOPASDFGHJKLZXCVBNM"[Math.floor(Math.random()*62)]}}return this.tabUUID};this.eventKey=this.getTabUUID();if(opt&&opt.eventKey){this.eventKey=opt.eventKey}this.setEventKey=function(key){this.eventKey=key};this.getEventKey=function(){return this.eventKey};this.connect=function(slot_name,signal_name,slot_function){if(slot_function===undefined){slot_function=signal_name;signal_name=slot_name;slot_name="sig"+this.sigId++}if(this.slotArray[signal_name]===undefined){this.slotArray[signal_name]={}}this.slotArray[signal_name][slot_name]=slot_function;if(this.debug)console.log("[js-api] На прослушивание сигнала "+signal_name+" добавлен слот "+slot_name+"",this.slotArray);return slot_name};this.disconnect=function(slot_name,signal_name){if(this.slotArray[signal_name]!==undefined){if(this.slotArray[signal_name][slot_name]!==undefined){this.slotArray[signal_name][slot_name]=undefined;return true}}return false};this.emit=function(signal_name,param,SignalNotFromThisTab){if(this.slotArray[signal_name]===undefined){if(this.debug)console.log("[js-api] На сигнал "+signal_name+" нет подписчиков")}else{if(this.debug)console.log("[js-api] Сигнал "+signal_name+" подписаны слоты");var obj=this.slotArray[signal_name];for(var slot in obj){if(obj.hasOwnProperty(slot)&&obj[slot]!==undefined){obj[slot](param,signal_name,SignalNotFromThisTab===true)}}}};this.emitAll=function(signal_name,param){this.emit(signal_name,param);try{if(window["localStorage"]!==undefined){var curent_custom_id=Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random();window["localStorage"][this.eventKey]=JSON.stringify({name:signal_name,custom_id:curent_custom_id,param:param})}return true}catch(e){return false}};this.setState=function(name,value,minTime){if(!this._states){this._states={}}var time=new Date;try{if(minTime){var value=window.localStorage["tabSignal_"+this.eventKey+name];if(value){var val=JSON.parse(value);if(val.time+minTime>time.getTime()&&val.tabUUID!=this.getTabUUID()){return false}}}window.localStorage["tabSignal_"+this.eventKey+name]=JSON.stringify({time:time.getTime(),value:value,tabUUID:this.getTabUUID()});return true}catch(e){if(minTime){var value=this._states["tabSignal_"+this.eventKey+name];if(value){var val=JSON.parse(value);if(val.time+minTime>time.getTime()&&val.tabUUID!=this.getTabUUID()){return false}}}this._states["tabSignal_"+this.eventKey+name]=JSON.stringify({time:time.getTime(),value:value,tabUUID:this.getTabUUID()});return true}};this.intervalUpdateState=function(name,value,minTime){var thisObj=this;if(thisObj.setState(name,value,minTime)){return setInterval(function(){thisObj.setState(name,value,minTime)},minTime/3,name,value,minTime)}return undefined};this.getState=function(name,maxTime){if(!this._states){this._states={}}try{var time=new Date;var value=window.localStorage["tabSignal_"+this.eventKey+name];if(value){var val=JSON.parse(value);if(!maxTime){return val.value}if(val.time+maxTime>time.getTime()){return val.value}return undefined}}catch(e){var time=new Date;var value=this._states["tabSignal_"+this.eventKey+name];if(value){var val=JSON.parse(value);if(!maxTime){return val.value}if(val.time+maxTime>time.getTime()){return val.value}return undefined}}return undefined};this.send_emit=this.emit;var thisTabSignalObj=this;this.init=true;if(window.addEventListener){window.addEventListener("storage",function(e){if(e.key&&e.key==thisTabSignalObj.eventKey){try{var data=JSON.parse(e.newValue);if(data!==undefined&&data.name!==undefined){if(thisTabSignalObj.debug>1)console.log(data);thisTabSignalObj.emit(data.name,data.param,true)}}catch(failed){}}},false)}else if(document.attachEvent){document.attachEvent("onstorage",function(e){if(e.key&&e.key==thisTabSignalObj.eventKey){try{var data=JSON.parse(e.newValue);if(data!==undefined&&data.name!==undefined){if(thisTabSignalObj.debug>1)console.log(data);thisTabSignalObj.emit(data.name,data.param,true)}}catch(failed){}}})}}}if(!window.tabSignal){window.tabSignal=new _tabSignal({eventKey:"tabSignal_storage_emit"})}window.comet_server_signal=function(){return window.tabSignal};var _cometServerApi=function(opt){if(opt){if(this.options===undefined){this.options={}}for(var key in opt){this.options[key]=opt[key]}}this.version="4.09";this.options={};this.tabSignal=new _tabSignal;this.options.nodeArray=["app.comet-server.ru"];this.options.node=undefined;this.options.roundrobin=false;this.is_master=undefined;this.instance_id=undefined;this.in_try_conect=false;this.subscription_array=new Array;this.custom_id=Math.random()*10+""+Math.random();this.custom_id=this.custom_id.replace(/[^0-9A-z]/,"").replace(/^(.{10}).*$/,"$1");this.time_to_reconect_on_error=[];this.time_to_reconect_on_close=[];this.in_abort=false;this.restart_time_id=false;this.start_timer=1200;this.reg_exp=new RegExp(/^([^.]+)\.([^.]+)$/);this.protocol="";if(document.location){this.protocol=window.location.protocol.replace(/[^s]/gim,"")}this.web_socket_error=[];this.isSendStatisticsData=[];this.web_socket_success=false;this.web_socket_error_timeOut=3e4;this.xhr_error=0;this.xhr_error_timeOut_id=3e4;this.authorized_status;this.socket;this.socketArray=[];this.use_WebSocket;this.request;this.status;this.send_msg_queue=[];this.send_msg_subscription=false;this.LogLevel=0;this.msgsUUIDs={};try{if(window["localStorage"]["comet_LogLevel"]){this.LogLevel=window["localStorage"]["comet_LogLevel"]/1}}catch(e){}this.getLogLevel=function(){return this.LogLevel};this.setLogLevel=function(level){this.LogLevel=level;try{window["localStorage"]["comet_LogLevel"]=level}catch(e){}};this.getCustomString=function(){var custom=Math.random()*10+""+Math.random();return custom.replace(/[^0-9A-z]/,"").replace(/^(.{10}).*$/,"$1")};this.getTabUUID=function(){return this.tabSignal.getTabUUID()};this.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=input.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<input.length;n++){var c=input.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}while(i<utftext.length){chr1=utftext.charCodeAt(i++);chr2=utftext.charCodeAt(i++);chr3=utftext.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4)}return output},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(i<input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}var string="";var i=0;var c=c1=c2=0;while(i<output.length){c=output.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=output.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=output.charCodeAt(i+1);c3=output.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}};this.stripslashes=function(str){return(str+"").replace(/\\(.?)/g,function(s,n1){switch(n1){case"\\":return"\\";case"0":return"\0";case"":return"";default:return n1}})};this.subscription_callBack=function(name,callBack,specialMarker){var thisObj=this;var sigId=name+"&&";if(specialMarker===undefined){sigId+=thisObj.tabSignal.connect(name,function(param){if(param.server_info.marker!==thisObj.custom_id&&param.server_info.marker!==undefined){return 0}callBack(param)})}else{sigId+=thisObj.tabSignal.connect(specialMarker,name,function(param){if(param.server_info.marker!==specialMarker){return 0}thisObj.tabSignal.disconnect(specialMarker,name);callBack(param)})}return sigId};this.subscription_once=function(specialMarker,callBack){var thisObj=this;var sigId=specialMarker+"&&";sigId+=thisObj.tabSignal.connect(specialMarker,specialMarker,function(param){thisObj.tabSignal.disconnect(specialMarker,specialMarker);callBack(param)});return sigId};this.subscription_slot_array=[];this.unsubscriptionAll=function(){for(var i=0;i<this.subscription_slot_array.length;i++){var val=this.subscription_slot_array[i];var sigName=val.replace(/^(.*)&&.*$/,"$1");var slotName=val.replace(/^.*&&(.*)$/,"$1");this.tabSignal.disconnect(slotName,sigName)}this.subscription_slot_array=[];return true};this.unsubscription=function(sigId){if(sigId===undefined){console.warn("cometApi.unsubscription вызван без аргументов.");console.warn("Чтобы отписаться от всех подписок разом вызовете cometApi.unsubscriptionAll() ");return false}else if(!sigId){return false}var sigName=sigId.replace(/^(.*)&&.*$/,"$1");var slotName=sigId.replace(/^.*&&(.*)$/,"$1");return this.tabSignal.disconnect(slotName,sigName)};var localArr_uuid={};this.addUUID=function(uuid){var d=new Date;try{localArr_uuid[uuid]=d.getTime()}catch(e){}};this.testUUID=function(uuid){try{return localArr_uuid[uuid]}catch(e){}};this.clearUUID=function(){var d=new Date;var time=d.getTime();try{localArr_uuid={}}catch(e){}};this.subscription=function(name,callback){if(name===undefined){return false}var thisObj=this;var nameArray=name.split("\n");if(nameArray.length>1){for(var i=0;i<nameArray.length;i++){this.subscription(nameArray[i],callback)}return}if(callback===undefined){callback=function(){}}var sigId=null;if(typeof name==="function"){sigId="comet_server_msg&&"+this.tabSignal.connect("comet_server_msg",name);this.subscription_slot_array.push(sigId);return sigId}if(name==="msg"||/^msg\./.test(name)){sigId=thisObj.subscription_callBack(name,callback);this.subscription_slot_array.push(sigId);return sigId}if(/^answer_to_web_/.test(name)){sigId=thisObj.subscription_callBack(name,callback);this.subscription_slot_array.push(sigId);return sigId}else if(/^#/.test(name)){name=name.replace("#","_answer_to_");sigId=thisObj.subscription_callBack(name,callback);this.subscription_slot_array.push(sigId);return sigId}if(name===""){name="comet_server_msg"}if(name.length<2){console.error("Error pipe is to short",name);return false}if(!/^[A-z0-9_.\-]+$/.test(name)){console.error("Invalid pipe name",name)}sigId=thisObj.subscription_callBack(name,callback);this.subscription_slot_array.push(sigId);if(name==="comet_server_msg"){return sigId}if(this.reg_exp.test(name)){var res=this.reg_exp.exec(name);name=res[1]}for(var i=0;i<this.subscription_array.length;i++){if(this.subscription_array[i]===name){return sigId}}this.subscription_array[this.subscription_array.length]=name;if(this.isMaster()===undefined){this.add_msg_to_queue("subscription\n"+this.subscription_array.join("\n"))}else if(this.isMaster()){if(this.LogLevel)console.log("[js-api] add subscription:"+name);if(this.UseWebSocket()){if(this.lastSubscriptionTimeoutId){clearTimeout(this.lastSubscriptionTimeoutId)}this.lastSubscriptionTimeoutId=setTimeout(function(){thisObj.lastSubscriptionTimeoutId=false;thisObj.send_msg("subscription\n"+thisObj.subscription_array.join("\n"))},50)}else{this.restart()}}else{thisObj.tabSignal.emit("comet_msg_slave_add_subscription_and_restart",this.subscription_array.join("\n"))}return sigId};this.isMaster=function(){return this.is_master};this.send_curent_subscription=function(){if(this.subscription_array.length===0){return}this.send_msg("subscription\n"+this.subscription_array.join("\n"))};this.getUUID=function(){if(this.options["uuid"]){return this.options["uuid"]}var a="qwertyuiopasdfghjklzxcvbnm1234567890QWERTYUIOPASDFGHJKLZXCVBNM_-";try{if(window["localStorage"]["comet_server_uuid"]!==undefined){this.options["uuid"]=window["localStorage"]["comet_server_uuid"]}else{this.options["uuid"]="";for(var i=0;i<32;i++){this.options["uuid"]+=a[Math.floor(Math.random()*a.length)]}window["localStorage"]["comet_server_uuid"]=this.options["uuid"]}}catch(e){this.options["uuid"]="";for(var i=0;i<32;i++){this.options["uuid"]+=a[Math.floor(Math.random()*a.length)]}}return this.options["uuid"]};this.getUrl=function(nodename){if(nodename===undefined){nodename=this.options.nodeArray[0]}if(this.UseWebSocket()===true){return"ws"+this.protocol+"://"+nodename+"/ws/sesion="+this.options.user_key+"&myid="+this.options.user_id+"&devid="+this.options.dev_id+"&v="+this.version+"&uuid="+this.getUUID()+"&api=js"}return"http"+this.protocol+"://"+nodename+"/sesion="+this.options.user_key+"&myid="+this.options.user_id+"&devid="+this.options.dev_id+"&v="+this.version+"&uuid="+this.getUUID()+"&api=js"};this.getUserId=function(){return this.options.user_id};this.getUserKey=function(){return this.options.user_key};this.getRealUserKey=function(){return this.tabSignal.getState("real_user_key")};this.setRealUserKey=function(real_user_key){return this.tabSignal.setState("real_user_key",real_user_key)};this.getDevId=function(){return this.options.dev_id};this.UseWebSocket=function(use){if(use===true){this.use_WebSocket=use}else if(use===false){this.use_WebSocket=use}else if(this.use_WebSocket===undefined){this.use_WebSocket=window.WebSocket!==undefined}return this.use_WebSocket};this.UseWss=function(use){if(use){this.protocol="s"}else if(use===undefined&&window.location&&window.location.protocol){this.protocol=window.location.protocol.replace(/[^s]/gim,"")}else{this.protocol=""}return this.protocol==="s"};this.options.isStart=false;this.updateEventKey=function(){this.tabSignal.setEventKey(this.options.nodeArray.join("_")+"_"+this.options.dev_id+"_"+this.options.user_id)};this.isUseWss=function(){return this.protocol==="s"};this.start=function(opt,callBack){this.options.isStart=true;if(opt!==undefined){for(var key in opt){this.options[key]=opt[key]}}if(this.options.wss!=undefined){this.UseWss(this.options.wss)}if(this.options.node){if(typeof this.options.node!="string"){this.options.nodeArray=this.options.node}else{this.options.nodeArray=[this.options.node]}}if(this.options.nodes){this.options.nodeArray=this.options.nodes}if(this.LogLevel)console.log("[js-api] start",[this.custom_id,opt]);this.UseWebSocket(window.WebSocket!==undefined);if(!this.options.dev_id){if(this.options.nodeArray[0]=="app.comet-server.ru"){console.warn("Comet: Not set dev_id",this.options.dev_id);console.warn("Comet: set dev_id = 15 for testing and demo access. Do not use this in production.",this.options.dev_id);console.warn("Comet: See https://comet-server.com/wiki/doku.php/en:comet:dev_id or https://comet-server.com/wiki/doku.php/comet:dev_id");this.options.dev_id="15"}else{this.options.dev_id="0"}}this.updateEventKey();this.in_abort=false;this.conect(callBack);return true};this.stop=function(){this.options.isStart=false;if(this.isMaster()){this.in_abort=true;if(this.UseWebSocket()){for(var i=0;i<this.socketArray.length;i++){if(this.socketArray[i]){this.socketArray[i].close()}}}else{this.request.abort()}}else{this.tabSignal.emit("comet_msg_slave_signal_stop")}};this.restart=function(opt){if(opt!==undefined){for(var key in opt){this.options[key]=opt[key]}}this.updateEventKey();if(!this.options.isStart){return this.start(opt)}if(this.isMaster()){if(this.UseWebSocket()){for(var i=0;i<this.socketArray.length;i++){if(this.socketArray[i]){if(this.LogLevel){console.log("[js-api] restart socket",i)}this.socketArray[i].close()}}}else{this.request.abort()}}else{this.tabSignal.emit("comet_msg_slave_signal_restart",opt)}};this.setAsSlave=function(callback){if(callback===undefined){callback=function(){}}var thisObj=this;var time_id=false;var last_time_id=false;thisObj.tabSignal.connect("slot_comet_msg_set_as_slave","comet_msg_set_as_slave",function(){if(thisObj.LogLevel){console.log("[js-api] comet_msg_set_as_slave: set is slave")}thisObj.tabSignal.disconnect("slot_comet_msg_set_as_slave","comet_msg_set_as_slave");thisObj.send_msg_from_queue();thisObj.tabSignal.connect("__comet_set_authorized_slot","__comet_authorized",function(param,arg){if(thisObj.LogLevel)console.log([param,arg]);if(param=="undefined"){setTimeout(function(){thisObj.tabSignal.emit("__comet_get_authorized_status")},200)}thisObj.setAuthorized(param)});thisObj.tabSignal.emit("__comet_get_authorized_status")});thisObj.tabSignal.connect("comet_msg_conect","comet_msg_master_signal",function(){if(time_id!==false){clearTimeout(time_id);time_id=false;if(thisObj.LogLevel)console.log("[js-api] Connection to server canceled");thisObj.tabSignal.disconnect("comet_msg_conect","comet_msg_master_signal");thisObj.tabSignal.connect("comet_msg_conect_to_master_signal","comet_msg_master_signal",function(){if(last_time_id!==false){clearTimeout(last_time_id)}last_time_id=setTimeout(function(){thisObj.tabSignal.disconnect("comet_msg_conect_to_master_signal","comet_msg_master_signal");thisObj.in_try_conect=false;thisObj.conect_to_server();callback()},thisObj.start_timer)})}if(thisObj.LogLevel)console.log("[js-api] set is slave");thisObj.is_master=false;thisObj.tabSignal.emit("comet_msg_set_as_slave","slave")});time_id=setTimeout(function(){thisObj.tabSignal.disconnect("comet_msg_conect","comet_msg_master_signal");thisObj.in_try_conect=false;thisObj.conect_to_server();callback()},this.start_timer)};this.setAsMaster=function(){var thisObj=this;this.is_master=true;if(this.LogLevel)console.log("[js-api] setAsMaster");thisObj.tabSignal.emit("comet_msg_new_master");var masterSignalIntervalId=setInterval(function(){},this.start_timer/6);thisObj.tabSignal.connect("comet_msg_master_detect","comet_msg_master_signal",function(event,signal_name,SignalNotFromThisTab){if(SignalNotFromThisTab&&thisObj.LogLevel){console.error("There was a collision, two master tabs were formed")}if(SignalNotFromThisTab&&event.custom_id>thisObj.custom_id){if(thisObj.LogLevel)console.log("[js-api] Yield power, go to slave tab mode");clearInterval(masterSignalIntervalId);thisObj.tabSignal.disconnect("comet_msg_master_detect","comet_msg_master_signal");thisObj.tabSignal.disconnect("comet_master_tab","comet_msg_slave_signal_restart");thisObj.tabSignal.disconnect("comet_master_tab","comet_msg_slave_signal_stop");thisObj.tabSignal.disconnect("comet_master_tab","comet_msg_slave_signal_start");thisObj.tabSignal.disconnect("comet_master_tab","comet_msg_slave_add_subscription_and_restart");thisObj.tabSignal.disconnect("comet_master_tab","comet_msg_slave_send_msg");thisObj.tabSignal.disconnect("comet_master_tab","__comet_get_authorized_status");thisObj.setAsSlave()}});thisObj.tabSignal.connect("comet_master_tab","comet_msg_slave_signal_restart",function(p,arg){if(thisObj.LogLevel)console.log([p,arg]);thisObj.restart(p)});thisObj.tabSignal.connect("comet_master_tab","comet_msg_slave_signal_stop",function(p,arg){if(thisObj.LogLevel)console.log([p,arg]);thisObj.stop()});thisObj.tabSignal.connect("comet_master_tab","comet_msg_slave_signal_start",function(p,arg){if(thisObj.LogLevel)console.log([p,arg]);thisObj.start()});thisObj.tabSignal.connect("comet_master_tab","comet_msg_slave_add_subscription_and_restart",function(p,arg){if(thisObj.LogLevel)console.log([p,arg]);thisObj.subscription(p)});thisObj.tabSignal.connect("comet_master_tab","comet_msg_slave_send_msg",function(p,arg){if(thisObj.LogLevel)console.log([p,arg]);thisObj.send_msg(p)});thisObj.tabSignal.disconnect("__comet_set_authorized_slot","__comet_authorized");thisObj.tabSignal.connect("comet_master_tab","__comet_get_authorized_status",function(p,arg){thisObj.tabSignal.emit("__comet_authorized",thisObj.isAuthorized())});setInterval(thisObj.clearUUID,1e3*60*3)};this.setAuthorized=function(value){if(this.LogLevel)console.log("[js-api] setAuthorized:",value);if(this.authorized_status!==value&&value===true){this.tabSignal.emit("__comet_onAuthSuccess")}else if(this.authorized_status!==value&&value===false){this.tabSignal.emit("__comet_onAuthFalill")}this.authorized_status=value;if(this.isMaster()){this.tabSignal.emit("__comet_authorized",this.authorized_status)}};this.onAuthSuccess=function(callback){this.tabSignal.connect("__comet_onAuthSuccess",callback)};this.onAuthFalill=function(callback){this.tabSignal.connect("__comet_onAuthFalill",callback)};this.isAuthorized=function(){return this.authorized_status};this.hasCriticalError=[];this.msg_cultivate=function(msg,indexInWsArr){if(this.LogLevel)console.log("[js-api] msg",msg);if(msg.data===undefined){return-1}if(msg.error>400){console.error("CometServerError:"+msg.error,"\n",msg.data,"\n","Fatal error, connection impossible. Details in the documentation http://comet-server.com/wiki/doku.php/comet:javascript_api:error");this.hasCriticalError[indexInWsArr]=true}if(msg.jscode!==undefined){eval(msg.jscode);return 0}if(msg.authorized!==undefined&&msg.event=="serverInfo"&&msg.pipe=="sys"){this.setAuthorized(msg.authorized==="true"||msg.authorized===true);this.setRealUserKey(msg.data.replace(" ","_"));return 0}var web_id=0;if(/^A::/.test(msg.data)){var r=msg.data.split(";");web_id=r[0].replace("A::","")/1;msg.data=r[1]}if(typeof msg.data=="string"){try{pmsg=JSON.parse(msg.data.replace(/\\'/g,"'"));if(pmsg!==undefined){msg.data=pmsg}}catch(failed){msg.data=this.stripslashes(msg.data);try{var pmsg=JSON.parse(msg.data);if(pmsg!==undefined){msg.data=pmsg}}catch(failed){try{var pmsg=JSON.parse(msg.data.replace(/\\'/g,"'"));if(pmsg!==undefined){msg.data=pmsg}}catch(failed){msg.data=this.stripslashes(msg.data);try{var pmsg=JSON.parse(msg.data);if(pmsg!==undefined){msg.data=pmsg}}catch(failed){try{var pmsg=JSON.parse(msg.data.replace(/\\'/g,"'"));if(pmsg!==undefined){msg.data=pmsg}}catch(failed){}}}}}}if(msg.user_id){web_id=msg.user_id}var result_msg={data:msg.data,server_info:{user_id:web_id,pipe:msg.pipe,event:msg.event,message_send_time:msg.message_send_time,history:msg.history===true,marker:msg.marker,uuid:msg.uuid}};if(msg&&msg.uuid){if(this.testUUID(msg.uuid)){if(this.LogLevel)console.log(["Duplicate",result_msg]);return}else{this.addUUID(msg.uuid)}}if(msg.data&&msg.data._cometApi_uuid){if(this.testUUID(msg.data._cometApi_uuid)){if(this.LogLevel)console.log(["Duplicate",result_msg]);return}else{this.addUUID(result_msg["data"]._cometApi_uuid);delete result_msg["data"]._cometApi_uuid}}if(this.LogLevel)console.log(["final msg",result_msg]);if(msg.pipe!=undefined){this.tabSignal.emit(msg.pipe,result_msg);if(msg.event!==undefined&&(typeof msg.event==="string"||typeof msg.event==="number")){this.tabSignal.emit(msg.pipe+"."+msg.event,result_msg)}}else if(msg.event!==undefined&&(typeof msg.event==="string"||typeof msg.event==="number")){this.tabSignal.emit("msg."+msg.event,result_msg);this.tabSignal.emit("msg",result_msg)}else{this.tabSignal.emit("msg",result_msg)}if(msg.marker){this.tabSignal.emit(msg.marker,result_msg)}this.tabSignal.emit("comet_server_msg",result_msg);return 1};this.socketArrayTest=function(){for(var i=0;i<this.socketArray.length;i++){var socket=this.socketArray[i];if(socket&&socket.readyState===1)return true}if(this.LogLevel>3)console.log("[js-api] socketArrayTest:false");return false};this.messageHistory=[];this.isSendErrorReport=false;this.socketArraySend=function(data){var count=0;for(var i=0;i<this.socketArray.length;i++){var socket=this.socketArray[i];if(socket&&socket.readyState===1){try{if(this.messageHistory.length<1e3){var now=new Date;this.messageHistory.push({data:data,time:now.getTime()})}socket.send(data)}catch(ex){if(this.LogLevel){console.log("[js-api] Failed to send data ",data,ex);continue}}count++}}if(count)return true;return false};this.send_msg_from_queue=function(){var thisObj=this;if(this.isMaster()===undefined){return false}else if(this.isMaster()===false){if(this.send_msg_subscription!==false){this.tabSignal.emit("comet_msg_slave_add_subscription_and_restart",this.send_msg_subscription);this.send_msg_subscription=false}if(this.send_msg_queue.length>0){for(var i=0;i<this.send_msg_queue.length;i++){this.tabSignal.emit("comet_msg_slave_send_msg",this.send_msg_queue[i])}this.send_msg_queue=[]}return true}else if(this.isMaster()){if(!this.UseWebSocket()){return false}if(this.socketArrayTest()){if(this.send_msg_subscription!==false){if(this.LogLevel)console.error("WebSocket-send-subscription:"+this.send_msg_subscription);this.socketArraySend(this.send_msg_subscription);this.send_msg_subscription=false}if(this.send_msg_queue.length>0){var j=10;for(var i=0;i<this.send_msg_queue.length;i++){j+=20;setTimeout(function(ri){if(this.LogLevel)console.log("[js-api] WebSocket-send-msg:",ri);thisObj.socketArraySend(ri)},j,this.send_msg_queue[i])}this.send_msg_queue=[]}return true}}return false};this.add_msg_to_queue=function(msg){var MsgType=false;MsgType=msg.split("\n");MsgType=MsgType[0];if(this.LogLevel)console.log("[js-api] add_msg_to_queue:",msg);if(MsgType==="subscription"){this.send_msg_subscription=msg}else{this.send_msg_queue.push(msg)}};this.send_msg=function(msg){if(this.isMaster()===undefined){if(this.LogLevel>3)console.log("[js-api] isMaster:undefined");this.add_msg_to_queue(msg);return false}else if(this.isMaster()===false){if(this.LogLevel>3)console.log("[js-api] isMaster:false");this.tabSignal.emit("comet_msg_slave_send_msg",msg)}else if(this.isMaster()){if(this.LogLevel>3)console.log("[js-api] isMaster:true");if(!this.UseWebSocket()){console.warn("WebSocket-send-msg: not use");return false}if(this.socketArrayTest()){this.send_msg_from_queue();if(this.LogLevel>2)console.log("[js-api] WebSocket-send-msg:"+msg);this.socketArraySend(msg);return true}else{this.add_msg_to_queue(msg);return false}}};this.web_pipe_send=function(pipe_name,event_name,msg){if(msg===undefined){msg=event_name;event_name="undefined";if(/[.]/.test(pipe_name)){event_name=pipe_name.replace(/^[^.]*\.(.*)$/,"$1");pipe_name=pipe_name.replace(/^(.*?)\.(.*)/,"$1")}}if(msg===undefined){return false}if(!/^web_/.test(pipe_name)&&!/^webauth_/.test(pipe_name)){console.error("Invalid channel name `"+pipe_name+"`. The channel should begin with web_",pipe_name);return}if(this.LogLevel)console.log(["web_pipe_send",pipe_name,msg]);return this.send_msg("web_pipe2\n"+pipe_name+"\n"+event_name+"\n*\n"+JSON.stringify(msg))};this.getTrackPipeUsers=function(pipe_name,callBack){if(!/^track_/.test(pipe_name)){console.error("Invalid channel name `"+pipe_name+"`. The channel should begin with track_",pipe_name);return}var marker=this.getCustomString();this.subscription_once(marker,callBack);if(this.LogLevel)console.log(["track_pipe_users",pipe_name]);return this.send_msg("track_pipe_users\n"+pipe_name+"\n"+marker)};this.getUserData=function(user_id,callBack){if(!user_id||/[^0-9]/.test(user_id)){console.error("Invalid user_id=`"+user_id+"`. The user_id should is integer");return}if(callBack===undefined){return}var marker=this.getCustomString();this.subscription_once(marker,callBack);if(this.LogLevel)console.log(["user_data",user_id]);return this.send_msg("user_data\n"+marker+"\n"+user_id)};this.multi_web_pipe_send=function(pipe_name,event_name,msg,count,interval){if(!count){count=3}if(!interval){interval=1e3}var uuid="jsapi";for(var i=0;i<11;i++){uuid+="qwertyuiopasdfghjklzxcvbnm1234567890QWERTYUIOPASDFGHJKLZXCVBNM"[Math.floor(Math.random()*62)]}msg._cometApi_uuid=uuid;var thisObj=this;for(var i=1;i<count;i++){setTimeout(function(pipe_name,event_name,msg){thisObj.web_pipe_send(pipe_name,event_name,msg)},i*interval,pipe_name,event_name,msg)}return this.web_pipe_send(pipe_name,event_name,msg)};this.sendStatistics=function(plugin_name,plugin_version,plugin_data){if(this.LogLevel)console.log(["sendStatistics",plugin_name,plugin_version,plugin_data]);return this.send_msg("statistics\n"+JSON.stringify({url:window.location.href,dev_id:this.options.dev_id,version:this.version,plugin:{name:plugin_name,version:plugin_version,data:plugin_data}}))};this.get_pipe_log=function(pipe_name,callBack){if(!pipe_name){console.trace("In CppComet API in get_pipe_log function argument `pipe_name` is required");return false}if(!this.UseWebSocket()){return false}var marker=this.getCustomString();if(callBack!==undefined){this.subscription(pipe_name,callBack)}this.send_msg("pipe_log\n"+pipe_name+"\n"+marker+"\n");return true};this.count_users_in_pipe=function(pipe_name,callBack){if(!this.UseWebSocket()){return false}var marker=this.getCustomString();this.subscription_once(marker,callBack);this.send_msg("pipe_count\n"+pipe_name+"\n"+marker+"\n");return true};this.isConnected=function(){for(var i=0;i<this.web_socket_error.length;i++){if(this.web_socket_error[i]==0){return true}}return false};this.conect_to_server=function(){var thisObj=this;if(this.LogLevel)console.log("[js-api] Connecting to the server");if(!this.isMaster())this.setAsMaster();if(this.UseWebSocket()){function initSocket(socket,indexInArr){if(!thisObj.time_to_reconect_on_error[indexInArr])thisObj.time_to_reconect_on_error[indexInArr]=300;if(!thisObj.time_to_reconect_on_close[indexInArr])thisObj.time_to_reconect_on_close[indexInArr]=30;if(!thisObj.web_socket_error[indexInArr])thisObj.web_socket_error[indexInArr]=0;socket.onopen=function(){if(thisObj.LogLevel)console.log("[js-api] WS Connection established.");if(thisObj.send_msg_subscription===false)thisObj.send_curent_subscription();thisObj.send_msg_from_queue();if(thisObj.options.nostat!==true){setTimeout(function(){if(thisObj.isSendStatisticsData[indexInArr]){return}thisObj.isSendStatisticsData[indexInArr]=true;thisObj.send_msg("statistics\n"+JSON.stringify({url:window.location.href,dev_id:thisObj.options.dev_id,version:thisObj.version}))},5e3)}};socket.onclose=function(event){if(event.wasClean||thisObj.in_abort===true){if(thisObj.LogLevel)console.log("[js-api] WS The connection is closed cleanly")}else{if(thisObj.hasCriticalError[indexInArr]){console.warn("Fatal error, connection impossible.");return}if(thisObj.LogLevel)console.log("[js-api] WS Connection failure");socket.close();thisObj.web_socket_error[indexInArr]++;if(thisObj.web_socket_error[indexInArr]>2&&thisObj.web_socket_success!==true&&!thisObj.isUseWss()){thisObj.UseWss(true);console.warn("There were more than 2 errors in Web sites including encryption")}else if(thisObj.web_socket_error[indexInArr]>5){thisObj.time_to_reconect_on_error[indexInArr]*=3}else if(thisObj.web_socket_error[indexInArr]>3){thisObj.time_to_reconect_on_error[indexInArr]+=2e3}if(thisObj.web_socket_error[indexInArr]===0){setTimeout(function(){var conect=function(){if(navigator.onLine===false){setTimeout(conect,300);return}var node=thisObj.options.nodeArray[indexInArr];var socket=new WebSocket(thisObj.getUrl(node));thisObj.socketArray[indexInArr]=socket;initSocket(socket,indexInArr)};conect()},thisObj.time_to_reconect_on_close[indexInArr])}else{if(thisObj.web_socket_success==true){}setTimeout(function(){var conect=function(){if(navigator.onLine===false){setTimeout(conect,300);return}var node=thisObj.options.nodeArray[indexInArr];var socket=new WebSocket(thisObj.getUrl(node));thisObj.socketArray[indexInArr]=socket;initSocket(socket,indexInArr)};conect()},thisObj.time_to_reconect_on_error[indexInArr])}}if(thisObj.LogLevel)console.log("[js-api] WS Code: "+event.code+" reason: "+event.reason)};socket.onmessage=function(event){thisObj.web_socket_success=true;thisObj.web_socket_error[indexInArr]=0;thisObj.time_to_reconect_on_error[indexInArr]=1e3;if(thisObj.LogLevel>1)console.log("[js-api] [1;32mWS Incoming message[0m:"+event.data);var lineArray=event.data.replace(/^\s+|\s+$/,"").split("\n");for(var i=0;i<lineArray.length;i++){var rj={};try{rj=JSON.parse(lineArray[i].replace(/\\'/g,"'"))}catch(failed){if(thisObj.LogLevel)console.error(failed);continue}thisObj.msg_cultivate(rj,indexInArr)}};socket.onerror=function(error){if(thisObj.LogLevel)console.log("[js-api] Error "+error.message)}}if(thisObj.socketArray){for(var i=0;i<this.socketArray.length;i++){if(thisObj.socketArray[i]){thisObj.socketArray[i].close()}}}thisObj.socketArray=[];var random_node=thisObj.options.user_id%thisObj.options.nodeArray.length;if(!random_node){random_node=Math.floor(Math.random()*thisObj.options.nodeArray.length)}for(var i=0;i<thisObj.options.nodeArray.length;i++){if(thisObj.hasCriticalError[i]){continue}if(thisObj.options.roundrobin==true&&random_node!=i){continue}var node=thisObj.options.nodeArray[i];console.log("[js-api] conect to "+thisObj.getUrl(node));var socket=new window.WebSocket(thisObj.getUrl(node));thisObj.socketArray.push(socket);initSocket(socket,thisObj.socketArray.length-1)}}else{try{thisObj.request=new XMLHttpRequest}catch(trymicrosoft){try{thisObj.request=new ActiveXObject("Msxml2.XMLHTTP")}catch(othermicrosoft){try{thisObj.request=new ActiveXObject("Microsoft.XMLHTTP")}catch(failed){thisObj.request=false}}}thisObj.request.onreadystatechange=function(){if(thisObj.request.status===200&&thisObj.in_abort!==true){var re=thisObj.request.responseText;if(thisObj.LogLevel)console.log("[js-api] Incoming message:"+re);var lineArray=re.replace(/^\s+|\s+$/,"").split("\n");for(var i=0;i<lineArray;i++){try{if(thisObj.LogLevel)console.log(lineArray[i]);var rj=JSON.parse(lineArray[i])}catch(failed){thisObj.in_conect_to_server=false;if(thisObj.LogLevel)console.log("[js-api] Error in xhr, reconnection via "+thisObj.time_to_reconect_on_error[0]+" seconds.");setTimeout(function(){thisObj.conect_to_server()},thisObj.time_to_reconect_on_error[0]);return false}thisObj.msg_cultivate(rj)}thisObj.in_conect_to_server=false;thisObj.conect_to_server()}else{thisObj.in_conect_to_server=false;if(thisObj.in_abort!==true){thisObj.xhr_error+=1;if(thisObj.xhr_error>30){thisObj.time_to_reconect_on_error[0]=9e4}else if(thisObj.xhr_error>10){thisObj.time_to_reconect_on_error[0]=3e4}else if(thisObj.xhr_error>3){thisObj.time_to_reconect_on_error[0]=1e4}if(thisObj.LogLevel||1)console.log("[js-api] Error in xhr, reconnection via "+thisObj.time_to_reconect_on_error[0]+" seconds.");setTimeout(function(){thisObj.conect_to_server()},thisObj.time_to_reconect_on_error[0]);setTimeout(function(){thisObj.xhr_error=0},thisObj.xhr_error_timeOut_id)}}};thisObj.request.open("POST",thisObj.getUrl(),true);thisObj.request.send(thisObj.subscription_array.join("\n"))}};this.conect=function(callback){if(this.isMaster()){return this.conect_to_server()}if(this.in_try_conect){if(this.LogLevel)console.log("[js-api] The connection to the server is already installed on another tab");this.tabSignal.emit("comet_msg_slave_signal_start");return false}this.in_try_conect=true;if(this.LogLevel)console.log("[js-api] Trying to connect to the server");this.setAsSlave(callback)};return this};var cometServerApi=_cometServerApi;var cometApi=new cometServerApi;function CometServer(){return cometApi}